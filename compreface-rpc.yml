name: Compreface
description: Face recognition and performer synchronization via Compreface
version: 2.0.0
url: https://github.com/smegmarip/stash-compreface-plugin
exec:
  - gorpc/stash-compreface-rpc
interface: rpc

settings:
  comprefaceUrl:
    displayName: Compreface Service URL
    description: URL of the Compreface service (leave empty for auto-detection at http://compreface:8000)
    type: STRING
  cooldownSeconds:
    displayName: Cooldown Period (seconds)
    description: Delay between batches to prevent hardware overheating (default 10 seconds)
    type: NUMBER
  detectionApiKey:
    displayName: Detection API Key
    description: Compreface detection API key (required)
    type: STRING
  frameServerUrl:
    displayName: Vision Frame Server URL
    description: URL of the stash-auto-vision service for frame extraction (leave empty to use default container url http://vision-frame-server:5001)
    type: STRING
  matchedTagName:
    displayName: Matched Tag Name
    description: Tag to mark matched images (default "Compreface Matched")
    type: STRING
  maxBatchSize:
    displayName: Maximum Batch Size
    description: Maximum items to process per batch (default 20, prevents hardware stress)
    type: NUMBER
  minSimilarity:
    displayName: Minimum Compreface Similarity Threshold
    description: Minimum compreface face similarity score 0.0-1.0 (default 0.81)
    type: STRING
  minFaceSize:
    displayName: Minimum Face Size
    description: Minimum face dimensions in pixels (default 64)
    type: NUMBER
  minConfidenceScore:
    displayName: Minimum Confidence Score
    description: Minimum face detection confidence score (default 0.7, range 0.0-1.0)
    type: STRING
  minQualityScore:
    displayName: Minimum Quality Score (Subject Creation)
    description: Minimum composite quality for new subjects (default 0 = use component gates, range 0.0-1.0)
    type: STRING
  minProcessingQualityScore:
    displayName: Minimum Quality Score (Recognition)
    description: Minimum composite quality for recognition attempts (default 0 = use component gates, range 0.0-1.0)
    type: STRING
  recognitionApiKey:
    displayName: Recognition API Key
    description: Compreface recognition API key (required)
    type: STRING
  scannedTagName:
    displayName: Scanned Tag Name
    description: Tag to mark scanned images (default "Compreface Scanned")
    type: STRING
  stashHostUrl:
    displayName: Stash Host URL
    description: URL of the Stash host (leave empty for auto-detection)
    type: STRING
  visionServiceUrl:
    displayName: Vision Service URL
    description: URL of the stash-auto-vision service for video face recognition (leave empty to disable, default http://vision-api:5010)
    type: STRING
  verificationApiKey:
    displayName: Verification API Key
    description: Compreface verification API key (optional)
    type: STRING

tasks:
  - name: Synchronize Performers
    description: Synchronize existing performers with Compreface subjects
    defaultArgs:
      mode: synchronizePerformers
      limit: 0

  - name: Recognize Images
    description: Detect and group faces in images using Vision Service
    defaultArgs:
      mode: recognizeImages
      limit: 0

  - name: Identify All Images
    description: Match faces in all images with existing performers
    defaultArgs:
      mode: identifyImagesAll
      limit: 0

  - name: Identify Unscanned Images
    description: Match faces in new images with existing performers
    defaultArgs:
      mode: identifyImagesNew
      limit: 0

  - name: Identify Single Image
    description: Identify faces in a specific image
    defaultArgs:
      mode: identifyImage
      imageId: null
      createPerformer: false
      associateExisting: true

  - name: Create Performer from Image
    description: Create new performer from detected face in image
    defaultArgs:
      mode: createPerformerFromImage
      imageId: null
      faceIndex: 0

  - name: Identify Gallery
    description: Identify faces in all images in a gallery
    defaultArgs:
      mode: identifyGallery
      galleryId: null
      createPerformer: false
      limit: 0

  - name: Reset Unmatched Images
    description: Remove scan tags from unmatched images
    defaultArgs:
      mode: resetUnmatchedImages
      limit: 0

  - name: Recognize New Scenes
    description: Extract and recognize faces from unscanned video scenes
    defaultArgs:
      mode: recognizeNewScenes
      limit: 0

  - name: Recognize New Scene Sprites
    description: Extract and recognize faces from unscanned scene sprite sheets
    defaultArgs:
      mode: recognizeNewSceneSprites
      limit: 0

  - name: Recognize All Scenes
    description: Extract and recognize faces from all video scenes
    defaultArgs:
      mode: recognizeAllScenes
      limit: 0

  - name: Recognize All Scene Sprites
    description: Extract and recognize faces from all scene sprite sheets
    defaultArgs:
      mode: recognizeAllSceneSprites
      limit: 0

  - name: Reset Unmatched Scenes
    description: Remove scan tags from unmatched scenes
    defaultArgs:
      mode: resetUnmatchedScenes
      limit: 0
